<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PinkWeather Display Development</title>
        <style>
            @font-face {
                font-family: "Barlow Condensed";
                src: url("../googz/Barlow_Condensed/BarlowCondensed-Regular.ttf")
                    format("truetype");
            }

            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f5f5f5;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: 20px;
            }
            .display-panel {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            .controls-panel {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .eink-display {
                border: 3px solid #333;
                background: #fff;
                display: inline-block;
                margin: 20px 0;
                position: relative;
            }
            .eink-display img {
                display: block;
                image-rendering: pixelated;
                image-rendering: -moz-crisp-edges;
                image-rendering: crisp-edges;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #333;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }
            .form-group input[type="number"] {
                text-align: right;
            }
            .button {
                background: #007cba;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                width: 100%;
            }
            .button:hover {
                background: #005a87;
            }
            .scenario-group {
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 10px;
                margin-bottom: 15px;
            }
            .scenario-group h4 {
                margin: 0 0 10px 0;
                color: #555;
            }
            .status-info {
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 4px;
                padding: 10px;
                margin-top: 15px;
                font-size: 12px;
            }
            .status-info h4 {
                margin: 0 0 8px 0;
                color: #495057;
            }
            .loading {
                opacity: 0.6;
                pointer-events: none;
            }
            .error {
                color: #dc3545;
                background: #f8d7da;
                border: 1px solid #f5c6cb;
                border-radius: 4px;
                padding: 10px;
                margin: 10px 0;
            }
            .specs {
                font-size: 12px;
                color: #666;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="display-panel">
                <h1>PinkWeather E-ink Display</h1>
                <p>Real-time preview of the weather display layout</p>

                <div class="eink-display">
                    <img
                        id="display-image"
                        src="/current_image.png"
                        alt="Weather Display"
                        width="244"
                        height="500"
                    />
                </div>

                <div class="specs">
                    Display: 122×250 pixels | Tri-color E-ink | 2× scaled for
                    visibility<br />
                    Fonts: Barlow Condensed 60px/30px + Terminal 8px (matching
                    hardware)
                </div>

                <div
                    id="error-message"
                    class="error"
                    style="display: none"
                ></div>

                <div class="status-info">
                    <h4>Current Display Status</h4>
                    <div id="status-content">Loading...</div>
                </div>
            </div>

            <div class="controls-panel">
                <h2>Display Controls</h2>

                <form id="display-form">
                    <div class="scenario-group">
                        <h4>Test Scenarios</h4>
                        <div class="form-group">
                            <label for="csv_scenario">Historical Data:</label>
                            <select id="csv_scenario" name="csv_scenario">
                                <option value="normal">Normal Data</option>
                                <option value="trending_up">Trending Up</option>
                                <option value="trending_down">
                                    Trending Down
                                </option>
                                <option value="volatile">Volatile Data</option>
                                <option value="seasonal">
                                    Seasonal Pattern
                                </option>
                                <option value="empty">No Data</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="status_scenario">System Status:</label>
                            <select id="status_scenario" name="status_scenario">
                                <option value="normal">Normal Operation</option>
                                <option value="no_sd">No SD Card</option>
                                <option value="long_running">
                                    Long Running
                                </option>
                                <option value="fresh_boot">Fresh Boot</option>
                            </select>
                        </div>
                    </div>

                    <div class="scenario-group">
                        <h4>Sensor Override</h4>
                        <div class="form-group">
                            <label for="temp_c">Temperature (°C):</label>
                            <input
                                type="number"
                                id="temp_c"
                                name="temp_c"
                                step="0.1"
                                min="-40"
                                max="60"
                                placeholder="Auto"
                            />
                        </div>

                        <div class="form-group">
                            <label for="humidity">Humidity (%):</label>
                            <input
                                type="number"
                                id="humidity"
                                name="humidity"
                                step="0.1"
                                min="0"
                                max="100"
                                placeholder="Auto"
                            />
                        </div>
                    </div>

                    <div class="scenario-group">
                        <h4>Quick Tests</h4>
                        <button
                            type="button"
                            class="button"
                            onclick="loadScenario('extreme_cold')"
                        >
                            Extreme Cold
                        </button>
                        <button
                            type="button"
                            class="button"
                            onclick="loadScenario('extreme_hot')"
                            style="margin-top: 5px"
                        >
                            Extreme Hot
                        </button>
                        <button
                            type="button"
                            class="button"
                            onclick="loadScenario('high_humidity')"
                            style="margin-top: 5px"
                        >
                            High Humidity
                        </button>
                        <button
                            type="button"
                            class="button"
                            onclick="loadScenario('low_humidity')"
                            style="margin-top: 5px"
                        >
                            Low Humidity
                        </button>
                    </div>

                    <button type="submit" class="button">Update Display</button>
                </form>

                <div class="status-info">
                    <h4>About</h4>
                    <p>
                        This tool previews the weather display layout using the
                        same rendering logic as the hardware. Test different
                        scenarios to ensure the display works correctly in
                        various conditions.
                    </p>
                </div>
            </div>
        </div>

        <script>
            const form = document.getElementById("display-form");
            const displayImage = document.getElementById("display-image");
            const errorMessage = document.getElementById("error-message");
            const statusContent = document.getElementById("status-content");

            // Auto-refresh the display on page load
            window.addEventListener("load", function () {
                updateDisplay();
            });

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                updateDisplay();
            });

            function loadScenario(scenario) {
                const scenarios = {
                    extreme_cold: {
                        temp_c: -25,
                        humidity: 20,
                        csv_scenario: "trending_down",
                        status_scenario: "normal",
                    },
                    extreme_hot: {
                        temp_c: 45,
                        humidity: 15,
                        csv_scenario: "trending_up",
                        status_scenario: "long_running",
                    },
                    high_humidity: {
                        temp_c: 28,
                        humidity: 85,
                        csv_scenario: "volatile",
                        status_scenario: "normal",
                    },
                    low_humidity: {
                        temp_c: 22,
                        humidity: 10,
                        csv_scenario: "normal",
                        status_scenario: "normal",
                    },
                };

                if (scenarios[scenario]) {
                    const config = scenarios[scenario];
                    document.getElementById("temp_c").value = config.temp_c;
                    document.getElementById("humidity").value = config.humidity;
                    document.getElementById("csv_scenario").value =
                        config.csv_scenario;
                    document.getElementById("status_scenario").value =
                        config.status_scenario;
                    updateDisplay();
                }
            }

            function updateDisplay() {
                // Show loading state
                form.classList.add("loading");
                errorMessage.style.display = "none";

                // Collect form data
                const formData = new FormData(form);

                // Submit to server
                fetch("/preview", {
                    method: "POST",
                    body: new URLSearchParams(formData),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // Force image reload by adding timestamp
                            displayImage.src =
                                data.image_url + "?t=" + Date.now();

                            // Update status info
                            if (data.sensor_data && data.system_status) {
                                statusContent.innerHTML = `
                            <strong>Sensor:</strong> ${data.sensor_data.temp_c.toFixed(1)}°C, ${data.sensor_data.humidity.toFixed(1)}%<br>
                            <strong>System:</strong> ${data.system_status.sd_available ? "SD OK" : "No SD"},
                            ${data.system_status.uptime} uptime, ${data.system_status.power_status}
                        `;
                            }
                        } else {
                            errorMessage.textContent = "Error: " + data.error;
                            errorMessage.style.display = "block";
                        }
                    })
                    .catch((error) => {
                        errorMessage.textContent =
                            "Network error: " + error.message;
                        errorMessage.style.display = "block";
                    })
                    .finally(() => {
                        form.classList.remove("loading");
                    });
            }

            // Auto-update every 5 seconds if no manual changes
            let autoUpdateTimer = setInterval(updateDisplay, 5000);

            // Reset auto-update timer when user interacts
            form.addEventListener("change", function () {
                clearInterval(autoUpdateTimer);
                autoUpdateTimer = setInterval(updateDisplay, 5000);
            });
        </script>
    </body>
</html>
