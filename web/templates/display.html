<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>pinkweather DEVEL</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #000000;
                color: #ffffff;
            }
            .container {
                max-width: 1400px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: 1fr 250px 250px;
                gap: 20px;
            }
            .display-panel {
                background: #000000;
                border: 1px solid #333333;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
            }
            .controls-panel {
                background: #000000;
                border: 1px solid #333333;
                padding: 20px;
                border-radius: 8px;
            }
            .info-panel {
                background: #000000;
                border: 1px solid #333333;
                padding: 20px;
                border-radius: 8px;
            }
            .eink-display {
                border: 3px solid #333;
                background: #fff;
                display: inline-block;
                margin: 20px 0;
                position: relative;
            }
            .eink-display img {
                display: block;
                image-rendering: pixelated;
                image-rendering: -moz-crisp-edges;
                image-rendering: crisp-edges;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #ffffff;
            }
            .form-group label input[type="checkbox"] {
                margin-right: 8px;
                width: auto;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 8px;
                border: 1px solid #333333;
                border-radius: 4px;
                font-size: 14px;
                background-color: #111111;
                color: #ffffff;
            }
            .form-group input[type="number"] {
                text-align: right;
            }
            .button {
                background: #ff00ff;
                color: #000000;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                width: 100%;
                font-weight: bold;
            }
            .button:hover {
                background: #cc00cc;
            }
            .scenario-group {
                border: 1px solid #333333;
                border-radius: 4px;
                padding: 10px;
                margin-bottom: 15px;
            }
            .scenario-group h4 {
                margin: 0 0 10px 0;
                color: #ff00ff;
            }
            .scenario-group button {
                margin-bottom: 1em;
            }
            .status-info {
                background: #111111;
                border: 1px solid #333333;
                border-radius: 4px;
                padding: 10px;
                margin-top: 15px;
                font-size: 12px;
            }
            .status-info h4 {
                margin: 0 0 8px 0;
                color: #ff00ff;
            }
            .loading {
                opacity: 0.6;
                pointer-events: none;
            }
            .error {
                color: #ff6666;
                background: #220000;
                border: 1px solid #660000;
                border-radius: 4px;
                padding: 10px;
                margin: 10px 0;
            }
            .specs {
                font-size: 12px;
                color: #cccccc;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="display-panel">
                <h1>
                    <b style="color: magenta"
                        ><b style="color: magenta">p</b>ink</b
                    >weather
                </h1>

                <div class="eink-display">
                    <img
                        id="display-image"
                        src="/current_image.png"
                        alt="Weather Display"
                        width="244"
                        height="500"
                        style="
                            image-rendering: pixelated;
                            image-rendering: -moz-crisp-edges;
                            image-rendering: crisp-edges;
                        "
                    />
                </div>

                <div class="specs" id="display-specs">
                    Display: 122×250 pixels | Tri-color E-ink | 2× scale<br />
                    Fonts: Barlow Condensed 60px/30px + Terminal 8px (matching
                    hardware)
                </div>

                <div
                    id="error-message"
                    class="error"
                    style="display: none"
                ></div>

                <div class="status-info">
                    <h4>Current Display Status</h4>
                    <div id="status-content">Loading...</div>
                </div>
            </div>

            <div class="controls-panel">
                <form id="display-form">
                    <div class="scenario-group">
                        <h4>Display Type</h4>
                        <div class="form-group">
                            <label for="display_type">Select Display:</label>
                            <select
                                id="display_type"
                                name="display_type"
                                onchange="switchDisplay()"
                            >
                                <option value="250x122">
                                    250×122 Weather Station
                                </option>
                                <option value="400x300">
                                    400×300 Weather Display
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="scenario-group" id="display-settings">
                        <h4>Display Settings</h4>
                        <div class="form-group">
                            <label>
                                <input
                                    type="checkbox"
                                    id="scale2x"
                                    checked
                                    onchange="toggleScale()"
                                />
                                2× Scale (244×500px)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input
                                    type="checkbox"
                                    id="auto-update"
                                    onchange="toggleAutoUpdate()"
                                />
                                Auto-update (5s)
                            </label>
                        </div>
                    </div>

                    <div class="scenario-group" id="weather-controls">
                        <h4>Test Scenarios</h4>
                        <div class="form-group">
                            <label for="csv_scenario">Historical Data:</label>
                            <select id="csv_scenario" name="csv_scenario">
                                <option value="normal">Normal Data</option>
                                <option value="trending_up">Trending Up</option>
                                <option value="trending_down">
                                    Trending Down
                                </option>
                                <option value="volatile">Volatile Data</option>
                                <option value="seasonal">
                                    Seasonal Pattern
                                </option>
                                <option value="empty">No Data</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="status_scenario">System Status:</label>
                            <select id="status_scenario" name="status_scenario">
                                <option value="normal">Normal Operation</option>
                                <option value="no_sd">No SD Card</option>
                                <option value="long_running">
                                    Long Running
                                </option>
                                <option value="fresh_boot">Fresh Boot</option>
                            </select>
                        </div>
                    </div>

                    <div class="scenario-group" id="weather-data-controls">
                        <h4>Weather Data</h4>
                        <div class="form-group">
                            <label>
                                <input
                                    type="checkbox"
                                    id="use_mock_weather"
                                    onchange="toggleWeatherSource()"
                                />
                                Use Mock Weather Data
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="mock_scenario">Mock Scenario:</label>
                            <select
                                id="mock_scenario"
                                name="mock_scenario"
                                disabled
                            >
                                <option value="winter_clear">
                                    Clear Winter Day
                                </option>
                                <option value="winter_storm" selected>
                                    Winter Storm
                                </option>
                                <option value="winter_mixed">
                                    Mixed Winter
                                </option>
                                <option value="spring_mild">Mild Spring</option>
                                <option value="spring_rain">Spring Rain</option>
                                <option value="spring_variable">
                                    Variable Spring
                                </option>
                                <option value="summer_hot">Hot Summer</option>
                                <option value="summer_storms">
                                    Summer Storms
                                </option>
                                <option value="summer_humid">
                                    Humid Summer
                                </option>
                                <option value="fall_crisp">Crisp Fall</option>
                                <option value="fall_rain">Fall Rain</option>
                                <option value="fall_variable">
                                    Variable Fall
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <small
                                >Use arrow keys: ←→ time (3h), ↑↓ season, Space
                                regenerate</small
                            >
                        </div>
                    </div>

                    <div class="scenario-group" id="sensor-controls">
                        <h4>Sensor Override</h4>
                        <div class="form-group">
                            <label for="temp_c">Temperature (°C):</label>
                            <input
                                type="number"
                                id="temp_c"
                                name="temp_c"
                                step="0.1"
                                min="-40"
                                max="60"
                                placeholder="Auto"
                            />
                        </div>

                        <div class="form-group">
                            <label for="humidity">Humidity (%):</label>
                            <input
                                type="number"
                                id="humidity"
                                name="humidity"
                                step="0.1"
                                min="0"
                                max="100"
                                placeholder="Auto"
                            />
                        </div>
                    </div>


                        <div
                            class="specs"
                            style="
                                font-size: 11px;
                                color: #888;
                                margin-top: 5px;
                            "
                        >
                            Markup: &lt;b&gt;bold&lt;/b&gt;,
                            &lt;i&gt;italic&lt;/i&gt;, &lt;bi&gt;bold
                            italic&lt;/bi&gt;, &lt;red&gt;red text&lt;/red&gt;
                        </div>
                    </div>

                    <button type="submit" class="button">Update Display</button>
                </form>
            </div>

            <div class="info-panel">
                <div class="scenario-group" id="quick-tests">
                    <h4>Quick Tests</h4>
                    <button
                        type="button"
                        class="button"
                        onclick="loadScenario('extreme_cold')"
                    >
                        Extreme Cold
                    </button>
                    <button
                        type="button"
                        class="button"
                        onclick="loadScenario('extreme_hot')"
                    >
                        Extreme Hot
                    </button>
                    <button
                        type="button"
                        class="button"
                        onclick="loadScenario('high_humidity')"
                    >
                        High Humidity
                    </button>
                    <button
                        type="button"
                        class="button"
                        onclick="loadScenario('low_humidity')"
                    >
                        Low Humidity
                    </button>
                </div>

                <div class="status-info">
                    <h4>About</h4>
                    <p>
                        This tool previews the weather display layout using the
                        same rendering logic as the hardware. Test different
                        scenarios to ensure the display works correctly in
                        various conditions.
                    </p>
                </div>
            </div>
        </div>

        <script>
            const form = document.getElementById("display-form");
            const displayImage = document.getElementById("display-image");
            const errorMessage = document.getElementById("error-message");
            const statusContent = document.getElementById("status-content");

            // LocalStorage key for settings
            const SETTINGS_KEY = "pinkweather_settings";

            // Save settings to localStorage
            function saveSettings() {
                const settings = {
                    displayType: document.getElementById("display_type").value,
                    scale2x: document.getElementById("scale2x").checked,
                    autoUpdate: document.getElementById("auto-update").checked,
                };
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            }

            // Load settings from localStorage
            function loadSettings() {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                if (savedSettings) {
                    try {
                        const settings = JSON.parse(savedSettings);

                        // Restore display type
                        if (settings.displayType) {
                            document.getElementById("display_type").value =
                                settings.displayType;
                        }

                        // Restore scale setting
                        if (settings.scale2x !== undefined) {
                            document.getElementById("scale2x").checked =
                                settings.scale2x;
                        }

                        // Restore auto-update setting
                        if (settings.autoUpdate !== undefined) {
                            document.getElementById("auto-update").checked =
                                settings.autoUpdate;
                        }

                        console.log("Restored settings:", settings);
                    } catch (e) {
                        console.warn("Failed to parse saved settings:", e);
                    }
                }
            }

            // Initialize settings on page load
            document.addEventListener("DOMContentLoaded", function () {
                loadSettings();
                switchDisplay(); // Apply display type
                toggleScale(); // Apply scale setting
                toggleAutoUpdate(); // Apply auto-update setting
            });

            // Auto-refresh the display on page load
            window.addEventListener("load", function () {
                updateDisplay();
            });

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                updateDisplay();
            });

            function loadScenario(scenario) {
                const scenarios = {
                    extreme_cold: {
                        temp_c: -25,
                        humidity: 20,
                        csv_scenario: "trending_down",
                        status_scenario: "normal",
                    },
                    extreme_hot: {
                        temp_c: 45,
                        humidity: 15,
                        csv_scenario: "trending_up",
                        status_scenario: "long_running",
                    },
                    high_humidity: {
                        temp_c: 28,
                        humidity: 85,
                        csv_scenario: "volatile",
                        status_scenario: "normal",
                    },
                    low_humidity: {
                        temp_c: 22,
                        humidity: 10,
                        csv_scenario: "normal",
                        status_scenario: "normal",
                    },
                };

                if (scenarios[scenario]) {
                    const config = scenarios[scenario];
                    document.getElementById("temp_c").value = config.temp_c;
                    document.getElementById("humidity").value = config.humidity;
                    document.getElementById("csv_scenario").value =
                        config.csv_scenario;
                    document.getElementById("status_scenario").value =
                        config.status_scenario;
                    updateDisplay();
                }
            }

            function switchDisplay() {
                const displayType =
                    document.getElementById("display_type").value;
                saveSettings(); // Save settings when changed
                const img = document.getElementById("display-image");
                const specs = document.getElementById("display-specs");
                const scale2x = document.getElementById("scale2x");

                // Show/hide controls based on display type
                const weatherControls =
                    document.getElementById("weather-controls");
                const sensorControls =
                    document.getElementById("sensor-controls");
                const quickTests = document.getElementById("quick-tests");

                if (displayType === "400x300") {
                    // Switch to 400x300 display
                    img.width = scale2x.checked ? 800 : 400;
                    img.height = scale2x.checked ? 600 : 300;
                    specs.innerHTML = `Display: 400×300 pixels | Tri-color E-ink | ${scale2x.checked ? "2×" : "1:1"} scale<br />Fonts: Vollkorn 20px (regular, bold, italic, bold-italic)`;

                    // Hide weather controls for 400x300
                    weatherControls.style.display = "none";
                    sensorControls.style.display = "none";
                    quickTests.style.display = "none";
                } else {
                    // Switch to 250x122 display
                    img.width = scale2x.checked ? 244 : 122;
                    img.height = scale2x.checked ? 500 : 250;
                    specs.innerHTML = `Display: 122×250 pixels | Tri-color E-ink | ${scale2x.checked ? "2×" : "1:1"} scale<br />Fonts: Barlow Condensed 60px/30px + Terminal 8px (matching hardware)`;

                    // Show weather controls for 250x122
                    weatherControls.style.display = "block";
                    sensorControls.style.display = "block";
                    quickTests.style.display = "block";
                }

                updateDisplay();
            }

            function toggleScale() {
                saveSettings(); // Save settings when changed
                const img = document.getElementById("display-image");
                const specs = document.getElementById("display-specs");
                const scale2x = document.getElementById("scale2x");
                const displayType =
                    document.getElementById("display_type").value;

                if (displayType === "400x300") {
                    if (scale2x.checked) {
                        img.width = 800;
                        img.height = 600;
                        specs.innerHTML =
                            "Display: 400×300 pixels | Tri-color E-ink | 2× scale<br />Fonts: Vollkorn 20px (regular, bold, italic, bold-italic)";
                    } else {
                        img.width = 400;
                        img.height = 300;
                        specs.innerHTML =
                            "Display: 400×300 pixels | Tri-color E-ink | 1:1 scale<br />Fonts: Vollkorn 20px (regular, bold, italic, bold-italic)";
                    }
                } else {
                    if (scale2x.checked) {
                        img.width = 244;
                        img.height = 500;
                        specs.innerHTML =
                            "Display: 122×250 pixels | Tri-color E-ink | 2× scale<br />Fonts: Barlow Condensed 60px/30px + Terminal 8px (matching hardware)";
                    } else {
                        img.width = 122;
                        img.height = 250;
                        specs.innerHTML =
                            "Display: 122×250 pixels | Tri-color E-ink | 1:1 scale<br />Fonts: Barlow Condensed 60px/30px + Terminal 8px (matching hardware)";
                    }
                }
            }

            function updateDisplay() {
                const useMockWeather =
                    document.getElementById("use_mock_weather").checked;
                const displayType = document.getElementById("display_type").value;

                console.log("updateDisplay called - Mock:", useMockWeather, "Display:", displayType, "Scenario:", currentScenario, "Timestamp:", currentTimestamp);

                // Show loading state
                form.classList.add("loading");
                errorMessage.style.display = "none";

                // Collect form data
                const formData = new FormData(form);

                // Add mock weather data to form if enabled
                if (useMockWeather) {
                    formData.append("use_mock_weather", "on");
                    formData.append("mock_timestamp", currentTimestamp);
                    formData.append(
                        "mock_scenario",
                        document.getElementById("mock_scenario").value,
                    );
                    console.log("Added mock data to form:", document.getElementById("mock_scenario").value, currentTimestamp);
                }

                // Submit to server
                fetch("/preview", {
                    method: "POST",
                    body: new URLSearchParams(formData),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // Force image reload by adding timestamp
                            displayImage.src =
                                data.image_url + "?t=" + Date.now();

                            // Update status info based on display type
                            if (data.display_type === "400x300") {
                                statusContent.innerHTML = `
                            <strong>Display:</strong> 400×300 Text Renderer<br>
                            <strong>Text:</strong> ${data.text_content ? data.text_content.substring(0, 50) + "..." : "No text"}
                        `;
                            } else if (data.sensor_data && data.system_status) {
                                statusContent.innerHTML = `
                            <strong>Sensor:</strong> ${data.sensor_data.temp_c.toFixed(1)}°C, ${data.sensor_data.humidity.toFixed(1)}%<br>
                            <strong>System:</strong> ${data.system_status.sd_available ? "SD OK" : "No SD"},
                            ${data.system_status.uptime} uptime, ${data.system_status.power_status}
                        `;
                            }
                        } else {
                            errorMessage.textContent = "Error: " + data.error;
                            errorMessage.style.display = "block";
                        }
                    })
                    .catch((error) => {
                        errorMessage.textContent =
                            "Network error: " + error.message;
                        errorMessage.style.display = "block";
                    })
                    .finally(() => {
                        form.classList.remove("loading");
                    });
            }

            // Auto-update timer (off by default)
            let autoUpdateTimer = null;
            let currentTimestamp = Math.floor(Date.now() / 1000);
            let currentScenario = "winter_storm";
            let seasons = ["winter", "spring", "summer", "fall"];
            let currentSeasonIndex = 0;

            // Keyboard controls
            document.addEventListener("keydown", function (e) {
                if (!document.getElementById("use_mock_weather").checked)
                    return;
                if (document.getElementById("display_type").value !== "400x300")
                    return;

                console.log("Key pressed:", e.key, "Mock enabled:", document.getElementById("use_mock_weather").checked);

                switch (e.key) {
                    case "ArrowLeft":
                        e.preventDefault();
                        stepTime(-1);
                        break;
                    case "ArrowRight":
                        e.preventDefault();
                        stepTime(1);
                        break;
                    case "ArrowUp":
                        e.preventDefault();
                        stepSeason(-1);
                        break;
                    case "ArrowDown":
                        e.preventDefault();
                        stepSeason(1);
                        break;
                    case " ":
                        e.preventDefault();
                        regenerateScenario();
                        break;
                }
            });

            function stepTime(direction) {
                currentTimestamp += direction * 10800; // 3 hours
                console.log("Stepping time:", direction, "new timestamp:", currentTimestamp);
                updateDisplay();
            }

            function stepSeason(direction) {
                currentSeasonIndex =
                    (currentSeasonIndex + direction + seasons.length) %
                    seasons.length;
                const season = seasons[currentSeasonIndex];
                const scenarios = {
                    winter: "winter_storm",
                    spring: "spring_rain",
                    summer: "summer_hot",
                    fall: "fall_rain",
                };
                currentScenario = scenarios[season];
                document.getElementById("mock_scenario").value =
                    currentScenario;
                updateDisplay();
            }

            function regenerateScenario() {
                currentTimestamp += Math.floor(Math.random() * 7200) - 3600;
                updateDisplay();
            }

            function toggleWeatherSource() {
                const useMock =
                    document.getElementById("use_mock_weather").checked;
                document.getElementById("mock_scenario").disabled = !useMock;
                currentScenario =
                    document.getElementById("mock_scenario").value;
                console.log("Weather source toggled:", useMock ? "mock" : "real");
                updateDisplay();
            }

            // Add event listener for scenario dropdown
            document.getElementById("mock_scenario").addEventListener("change", function() {
                currentScenario = this.value;
                console.log("Scenario changed to:", currentScenario);
                updateDisplay();
            });

            function toggleAutoUpdate() {
                saveSettings(); // Save settings when changed
                const checkbox = document.getElementById("auto-update");
                if (checkbox.checked) {
                    // Start auto-update
                    autoUpdateTimer = setInterval(updateDisplay, 5000);
                } else {
                    // Stop auto-update
                    if (autoUpdateTimer) {
                        clearInterval(autoUpdateTimer);
                        autoUpdateTimer = null;
                    }
                }
            }

            // Reset auto-update timer when user interacts (only if enabled)
            form.addEventListener("change", function () {
                const checkbox = document.getElementById("auto-update");
                if (checkbox.checked && autoUpdateTimer) {
                    clearInterval(autoUpdateTimer);
                    autoUpdateTimer = setInterval(updateDisplay, 5000);
                }
            });
        </script>
    </body>
</html>
