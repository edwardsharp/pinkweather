<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>pinkweather viewer</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                background-color: #000000;
                color: #ffffff;
                font-family: "Monaco", "Consolas", monospace;
                font-size: 14px;
                line-height: 1.4;
                overflow: hidden;
            }

            .container {
                height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .header {
                background-color: #111111;
                padding: 10px 20px;
                border-bottom: 2px solid #ff00ff;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-shrink: 0;
            }

            .title {
                color: white;
                font-weight: bold;
                font-size: 16px;
            }

            .controls {
                display: flex;
                gap: 15px;
                align-items: center;
            }

            .control-group {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .control-group label {
                color: #ffffff;
                font-size: 12px;
            }

            select {
                background-color: #222222;
                color: #ffffff;
                border: 1px solid #ff00ff;
                padding: 4px 8px;
                font-size: 12px;
                font-family: inherit;
            }

            select:focus {
                outline: none;
                border-color: #ffffff;
            }

            .progress {
                color: #ff00ff;
                font-size: 12px;
            }

            .main-content {
                flex: 1;
                display: flex;
                min-height: 0;
            }

            .display-area {
                flex: 1;
                background-color: #111111;
                margin: 20px;
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .weather-display {
                width: 400px;
                height: 300px;
                background-color: #ffffff;
                border: 1px solid #cccccc;
                position: relative;
                overflow: hidden;
            }

            .weather-display img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .no-image {
                display: flex;
                align-items: center;
                justify-content: center;
                color: #000000;
                font-family: Arial, sans-serif;
                font-size: 14px;
                padding: 20px;
                text-align: center;
            }

            .metadata {
                width: 350px;
                background-color: #111111;
                margin: 20px 0 20px 0;
                padding: 20px;
                overflow-y: auto;
                display: block;
            }

            .metadata.visible {
                display: block;
            }

            .metadata h3 {
                color: #ff00ff;
                margin-bottom: 15px;
                font-size: 14px;
            }

            .metadata-row {
                margin-bottom: 8px;
                font-size: 12px;
            }

            .metadata-label {
                color: #ff00ff;
                display: inline-block;
                width: 120px;
            }

            .metadata-value {
                color: #ffffff;
            }

            .narrative-text {
                background-color: #222222;
                padding: 10px;
                margin: 10px 0;
                border-left: 3px solid #ff00ff;
                font-size: 12px;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .status-bar {
                background-color: #111111;
                padding: 8px 20px;
                border-top: 1px solid #ff00ff;
                font-size: 12px;
                color: #ff00ff;
                flex-shrink: 0;
            }

            .help-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.9);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .help-content {
                background-color: #111111;
                border: 2px solid #ff00ff;
                padding: 30px;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .help-content h3 {
                color: #ff00ff;
                margin-bottom: 15px;
            }

            .help-content ul {
                list-style: none;
                padding: 0;
            }

            .help-content li {
                margin-bottom: 8px;
                padding-left: 15px;
            }

            .help-content .key {
                color: #ff00ff;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="title">
                    <b style="color: magenta">pink</b>weather
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label for="dataset-select">Dataset:</label>
                        <select id="dataset-select">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="date-select">Jump to:</label>
                        <select id="date-select">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="overflow-filter">Overflow:</label>
                        <select id="overflow-filter">
                            <option value="all">All</option>
                            <option value="overflow">Only Overflow</option>
                            <option value="fits">Only Fits</option>
                        </select>
                    </div>
                    <div class="progress" id="progress">0 / 0</div>
                </div>
            </div>

            <div class="main-content">
                <div class="display-area">
                    <div class="weather-display" id="weather-display">
                        Loading...
                    </div>
                </div>
                <div class="metadata" id="metadata">
                    <h3>Metadata (M to toggle)</h3>
                    <div id="metadata-content"></div>
                </div>
            </div>

            <div class="status-bar">
                Press H for help | Arrow keys to navigate | M to toggle metadata
            </div>

            <div class="help-overlay" id="help-overlay">
                <div class="help-content">
                    <h3>Keyboard Controls</h3>
                    <ul>
                        <li><span class="key">←/→</span> Previous/Next hour</li>
                        <li><span class="key">ꜛ/ꜜ</span> Jump 24 hours</li>
                        <li>
                            <span class="key">Home/End</span> First/Last record
                        </li>
                        <li>
                            <span class="key">M</span> Toggle metadata panel
                        </li>
                        <li><span class="key">H</span> Toggle this help</li>
                        <li><span class="key">Esc</span> Close help</li>
                    </ul>
                    <p
                        style="
                            margin-top: 15px;
                            color: #ffffff;
                            font-size: 12px;
                        "
                    >
                        Use dropdown controls to switch datasets, jump to
                        specific dates, or filter by overflow status.
                    </p>
                </div>
            </div>
        </div>

        <script>
            // DATA_PLACEHOLDER - will be replaced with actual data
            const narrativeData = [];
            const availableDatasets = {};
            const allDatasetsData = {};
            let currentDataset = "";
            let filteredData = [];
            let currentIndex = 0;

            function populateDatasetSelect() {
                const select = document.getElementById("dataset-select");
                select.innerHTML = "";

                Object.entries(availableDatasets).forEach(([key, dataset]) => {
                    const option = document.createElement("option");
                    option.value = key;
                    option.textContent = dataset.name;
                    option.selected = key === currentDataset;
                    select.appendChild(option);
                });

                select.addEventListener("change", switchDataset);
            }

            function populateDateSelect() {
                const select = document.getElementById("date-select");
                const dates = [
                    ...new Set(narrativeData.map((record) => record.date)),
                ].sort();

                select.innerHTML = '<option value="">Select date...</option>';
                dates.forEach((date) => {
                    const option = document.createElement("option");
                    option.value = date;
                    option.textContent = date;
                    select.appendChild(option);
                });
            }

            function updateDisplay() {
                if (filteredData.length === 0) return;

                const record = filteredData[currentIndex];
                const display = document.getElementById("weather-display");
                // Construct image filename from timestamp if not provided
                const imageFilename =
                    record.image_filename ||
                    (() => {
                        const date = new Date(record.timestamp * 1000);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(
                            2,
                            "0",
                        );
                        const day = String(date.getDate()).padStart(2, "0");
                        const hours = String(date.getHours()).padStart(2, "0");
                        const minutes = String(date.getMinutes()).padStart(
                            2,
                            "0",
                        );
                        const seconds = String(date.getSeconds()).padStart(
                            2,
                            "0",
                        );
                        return `${year}${month}${day}_${hours}${minutes}${seconds}.png`;
                    })();

                // Use dataset-specific image directory
                const imageDir = currentDataset
                    ? `images/${currentDataset}`
                    : "images";
                const imagePath = `${imageDir}/${imageFilename}`;

                // Update the date select to show current date
                const dateSelect = document.getElementById("date-select");
                dateSelect.value = record.date;

                // Try to load the actual image
                const img = new Image();
                img.onload = function () {
                    display.innerHTML = `<img src="${imagePath}" alt="Weather display for ${record.date} ${record.hour}">`;
                };
                img.onerror = function () {
                    display.innerHTML = `
                    <div class="no-image">
                        <div>
                            <strong>${record.date} ${record.hour}</strong><br>
                            ${record.weather_desc}<br>
                            ${record.temp}°C<br>
                            <br>
                            Image not found: ${imagePath}
                        </div>
                    </div>
                `;
                };
                img.src = imagePath;

                updateMetadata(record);
            }

            function updateMetadata(record) {
                const content = document.getElementById("metadata-content");
                content.innerHTML = `
                <div class="metadata-row">
                    <span class="metadata-label">Timestamp:</span>
                    <span class="metadata-value">${record.timestamp}</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Date:</span>
                    <span class="metadata-value">${record.date}</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Hour:</span>
                    <span class="metadata-value">${record.hour}</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Temperature:</span>
                    <span class="metadata-value">${record.temp}°C</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Weather:</span>
                    <span class="metadata-value">${record.weather_desc}</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Text Width:</span>
                    <span class="metadata-value">${record.text_length_px}px</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Text Height:</span>
                    <span class="metadata-value">${record.text_height_px}px</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Line Count:</span>
                    <span class="metadata-value">${record.line_count}</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Fits Display:</span>
                    <span class="metadata-value">${record.fits_display}</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Characters:</span>
                    <span class="metadata-value">${record.char_count}</span>
                </div>
                <div class="metadata-row">
                    <span class="metadata-label">Overflow Lines:</span>
                    <span class="metadata-value">${record.overflow_lines}</span>
                </div>
                <div class="narrative-text">${record.narrative_text}</div>
            `;
            }

            function updateProgress() {
                document.getElementById("progress").textContent =
                    `${currentIndex + 1} / ${filteredData.length}`;
            }

            function navigate(direction) {
                const oldIndex = currentIndex;

                if (direction === "next") {
                    currentIndex = Math.min(
                        currentIndex + 1,
                        filteredData.length - 1,
                    );
                } else if (direction === "prev") {
                    currentIndex = Math.max(currentIndex - 1, 0);
                } else if (direction === "pageup") {
                    currentIndex = Math.max(currentIndex - 24, 0);
                } else if (direction === "pagedown") {
                    currentIndex = Math.min(
                        currentIndex + 24,
                        filteredData.length - 1,
                    );
                } else if (direction === "home") {
                    currentIndex = 0;
                } else if (direction === "end") {
                    currentIndex = filteredData.length - 1;
                }

                if (currentIndex !== oldIndex) {
                    updateDisplay();
                    updateProgress();
                }
            }

            function filterData() {
                const filterValue =
                    document.getElementById("overflow-filter").value;

                if (filterValue === "all") {
                    filteredData = narrativeData.slice();
                } else if (filterValue === "overflow") {
                    filteredData = narrativeData.filter(
                        (record) => record.fits_display === "False",
                    );
                } else if (filterValue === "fits") {
                    filteredData = narrativeData.filter(
                        (record) => record.fits_display === "True",
                    );
                }

                currentIndex = 0;
                updateDisplay();
                updateProgress();
            }

            function jumpToDate() {
                const selectedDate =
                    document.getElementById("date-select").value;
                if (!selectedDate) return;

                const index = filteredData.findIndex(
                    (record) => record.date === selectedDate,
                );
                if (index >= 0) {
                    currentIndex = index;
                    updateDisplay();
                    updateProgress();
                }
            }

            function toggleMetadata() {
                const metadata = document.getElementById("metadata");
                metadata.classList.toggle("visible");
            }

            function toggleHelp() {
                const help = document.getElementById("help-overlay");
                const isVisible = help.style.display === "flex";
                help.style.display = isVisible ? "none" : "flex";
            }

            function switchDataset() {
                const select = document.getElementById("dataset-select");
                const selectedDataset = select.value;

                if (!selectedDataset || selectedDataset === currentDataset) {
                    return;
                }

                try {
                    // Show loading
                    document.getElementById("weather-display").innerHTML =
                        '<div class="no-image">Loading dataset...</div>';

                    // Use embedded dataset data
                    const newData = allDatasetsData[selectedDataset] || [];

                    if (newData.length === 0) {
                        throw new Error(
                            `No data found for dataset: ${selectedDataset}`,
                        );
                    }

                    // Update global data
                    narrativeData.length = 0;
                    narrativeData.push(...newData);
                    currentDataset = selectedDataset;

                    // Reinitialize
                    currentIndex = 0;
                    filteredData = narrativeData.slice();
                    populateDateSelect();
                    filterData(); // Reapply current filter
                    updateDisplay();
                    updateProgress();

                    console.log(
                        `Switched to ${availableDatasets[selectedDataset].name}: ${newData.length} records`,
                    );
                } catch (error) {
                    console.error("Error loading dataset:", error);
                    document.getElementById("weather-display").innerHTML =
                        '<div class="no-image">Error loading dataset: ' +
                        error.message +
                        "</div>";
                }
            }

            // Event listeners
            document.addEventListener("keydown", (e) => {
                switch (e.key) {
                    case "ArrowRight":
                        navigate("next");
                        e.preventDefault();
                        break;
                    case "ArrowLeft":
                        navigate("prev");
                        e.preventDefault();
                        break;
                    case "ArrowUp":
                        navigate("pageup");
                        e.preventDefault();
                        break;
                    case "ArrowDown":
                        navigate("pagedown");
                        e.preventDefault();
                        break;
                    case "Home":
                        navigate("home");
                        e.preventDefault();
                        break;
                    case "End":
                        navigate("end");
                        e.preventDefault();
                        break;
                    case "m":
                    case "M":
                        toggleMetadata();
                        break;
                    case "h":
                    case "H":
                        toggleHelp();
                        break;
                    case "Escape":
                        document.getElementById("help-overlay").style.display =
                            "none";
                        break;
                }
            });

            document
                .getElementById("overflow-filter")
                .addEventListener("change", filterData);
            document
                .getElementById("date-select")
                .addEventListener("change", jumpToDate);
            document
                .getElementById("help-overlay")
                .addEventListener("click", (e) => {
                    if (e.target === e.currentTarget) {
                        toggleHelp();
                    }
                });

            // Initialize
            function init() {
                // Initialize dataset selector if available
                if (Object.keys(availableDatasets).length > 0) {
                    populateDatasetSelect();
                }

                if (narrativeData.length === 0) {
                    document.getElementById("weather-display").innerHTML =
                        '<div class="no-image">No data loaded</div>';
                    return;
                }

                filteredData = narrativeData.slice();
                populateDateSelect();
                updateDisplay();
                updateProgress();
            }

            // Start when page loads
            window.addEventListener("load", init);
        </script>
    </body>
</html>
