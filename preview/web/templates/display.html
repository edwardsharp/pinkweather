<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>pinkweather DEVEL</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #000000;
                color: #ffffff;
            }
            .container {
                max-width: 1400px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: 1fr 250px 250px;
                gap: 20px;
            }
            .display-panel {
                background: #000000;
                border: 1px solid #333333;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
            }
            .controls-panel {
                background: #000000;
                border: 1px solid #333333;
                padding: 20px;
                border-radius: 8px;
            }
            .info-panel {
                background: #000000;
                border: 1px solid #333333;
                padding: 20px;
                border-radius: 8px;
            }
            .eink-display {
                border: 3px solid #333;
                background: #fff;
                display: inline-block;
                margin: 20px 0;
                position: relative;
            }
            .eink-display img {
                display: block;
                image-rendering: pixelated;
                image-rendering: -moz-crisp-edges;
                image-rendering: crisp-edges;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #ffffff;
            }
            .form-group label input[type="checkbox"] {
                margin-right: 8px;
                width: auto;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 8px;
                border: 1px solid #333333;
                border-radius: 4px;
                font-size: 14px;
                background-color: #111111;
                color: #ffffff;
            }
            .form-group input[type="number"] {
                text-align: right;
            }
            .button {
                background: #ff00ff;
                color: #000000;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                width: 100%;
                font-weight: bold;
                max-height: 3em;
                margin-bottom: 1em;
            }
            .button:hover {
                background: #cc00cc;
            }
            .scenario-group {
                border: 1px solid #333333;
                border-radius: 4px;
                padding: 10px;
                margin-bottom: 15px;
            }
            .scenario-group h4 {
                margin: 0 0 10px 0;
                color: #ff00ff;
            }
            .scenario-group button {
                margin-bottom: 1em;
            }
            .status-info {
                background: #111111;
                border: 1px solid #333333;
                border-radius: 4px;
                padding: 10px;
                margin-top: 15px;
                font-size: 12px;
            }
            .status-info h4 {
                margin: 0 0 8px 0;
                color: #ff00ff;
            }
            .loading {
                opacity: 0.6;
                pointer-events: none;
            }
            .error {
                color: #ff6666;
                background: #220000;
                border: 1px solid #660000;
                border-radius: 4px;
                padding: 10px;
                margin: 10px 0;
            }
            .specs {
                font-size: 12px;
                color: #cccccc;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="display-panel">
                <h1>
                    <b style="color: magenta"
                        ><b style="color: magenta">p</b>ink</b
                    >weather
                </h1>

                <div class="eink-display">
                    <img
                        id="display-image"
                        src="/current_image.png"
                        alt="Weather Display"
                        width="244"
                        height="500"
                        style="
                            image-rendering: pixelated;
                            image-rendering: -moz-crisp-edges;
                            image-rendering: crisp-edges;
                        "
                    />
                </div>

                <div class="specs" id="display-specs">
                    Display: 122×250 pixels | Tri-color E-ink | 2× scale<br />
                    Fonts: Barlow Condensed 60px/30px + Terminal 8px (matching
                    hardware)
                </div>

                <div
                    id="error-message"
                    class="error"
                    style="display: none"
                ></div>

                <div class="status-info">
                    <h4>Current Display Status</h4>
                    <div id="status-content">Loading...</div>
                    <div id="timestamp-status" style="margin-top: 10px; font-family: monospace; font-size: 12px;">
                        <div>Current Time: <span id="current-timestamp">--</span></div>
                        <div>Data Range: <span id="data-range">--</span></div>
                        <div id="range-warning" style="color: orange; display: none;">⚠ Outside available data range</div>
                        <div id="yesterday-status" style="margin-top: 5px; color: #666; display: none;">
                            Yesterday: <span id="yesterday-data">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <form id="display-form">
                    <div class="scenario-group">
                        <h4>Display Type</h4>
                        <div class="form-group">
                            <label for="display_type">Select Display:</label>
                            <select
                                id="display_type"
                                name="display_type"
                                onchange="switchDisplay()"
                            >
                                <option value="400x300">
                                    400×300 Weather Display
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="api_source">API Source:</label>
                            <select id="api_source" name="api_source" onchange="updateDisplay(); saveSettings();">
                                <option value="openweathermap">OpenWeatherMap</option>
                                <option value="open-meteo" selected>Open-Meteo</option>
                            </select>
                        </div>
                    </div>

                    <div class="scenario-group" id="display-settings">
                        <h4>Display Settings</h4>
                        <div class="form-group">
                            <label>
                                <input
                                    type="checkbox"
                                    id="scale2x"
                                    checked
                                    onchange="toggleScale()"
                                />
                                2× Scale (800×600px)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input
                                    type="checkbox"
                                    id="auto-update"
                                    onchange="toggleAutoUpdate()"
                                />
                                Auto-update (30s)
                            </label>
                        </div>
                    </div>



                    <div class="scenario-group" id="weather-data-controls">
                        <h4>Weather Data</h4>
                        <div class="form-group">
                            <label>
                                <input
                                    type="checkbox"
                                    id="use_mock_weather"
                                    onchange="toggleWeatherSource()"
                                />
                                Use Historical CSV Data
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="mock_scenario">CSV Dataset:</label>
                            <select
                                id="mock_scenario"
                                name="mock_scenario"
                                disabled
                            >
                                <option value="ny_2024" selected>
                                    New York 2024 Historical Data
                                </option>
                                <option value="toronto_2025">
                                    Toronto 2025 Historical Data
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <small
                                >Use arrow keys: ←→ time (3h), ↑↓ week, Space
                                regenerate</small
                            >
                        </div>
                    </div>


                    <button type="submit" class="button" id="update-display-btn">Update Display</button>
                    <button type="button" class="button" onclick="resetSettings()" style="background: #ff6666;">
                        Reset All Settings
                    </button>

                        <!--<div
                            class="specs"
                            style="
                                font-size: 11px;
                                color: #888;
                                margin-top: 5px;
                            "
                        >
                            Markup: &lt;b&gt;bold&lt;/b&gt;,
                            &lt;i&gt;italic&lt;/i&gt;, &lt;bi&gt;bold
                            italic&lt;/bi&gt;, &lt;red&gt;red text&lt;/red&gt;
                        </div>-->
                    </div>

                    <!--<div class="info-panel">

                        <div class="status-info">
                            <h4>About</h4>
                            <p>
                                This tool previews the weather display layout using the
                                same rendering logic as the hardware. Test different
                                scenarios to ensure the display works correctly in
                                various conditions.
                            </p>
                        </div>
                    </div>-->


                </form>
            </div>


        </div>

        <script>
            const form = document.getElementById("display-form");
            const displayImage = document.getElementById("display-image");
            const errorMessage = document.getElementById("error-message");
            const statusContent = document.getElementById("status-content");

            // LocalStorage key for settings
            const SETTINGS_KEY = "pinkweather_settings";

            // Save settings to localStorage
            function saveSettings() {
                const settings = {
                    displayType: document.getElementById("display_type").value,
                    apiSource: document.getElementById("api_source").value,
                    scale2x: document.getElementById("scale2x").checked,
                    autoUpdate: document.getElementById("auto-update").checked,
                    useMockWeather: document.getElementById("use_mock_weather").checked,
                    mockScenario: document.getElementById("mock_scenario").value,
                    currentTimestamp: currentTimestamp,
                };
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            }

            // Load settings from localStorage
            function loadSettings() {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                if (savedSettings) {
                    try {
                        const settings = JSON.parse(savedSettings);

                        // Restore display type
                        if (settings.displayType) {
                            document.getElementById("display_type").value =
                                settings.displayType;
                        }

                        // Restore API source
                        if (settings.apiSource) {
                            document.getElementById("api_source").value =
                                settings.apiSource;
                        }

                        // Restore scale setting
                        if (settings.scale2x !== undefined) {
                            document.getElementById("scale2x").checked =
                                settings.scale2x;
                        }

                        // Restore auto-update setting
                        if (settings.autoUpdate !== undefined) {
                            document.getElementById("auto-update").checked =
                                settings.autoUpdate;
                        }

                        // Restore mock weather settings
                        if (settings.useMockWeather !== undefined) {
                            document.getElementById("use_mock_weather").checked =
                                settings.useMockWeather;
                            toggleWeatherSource(); // Update UI accordingly
                        }

                        if (settings.mockScenario) {
                            document.getElementById("mock_scenario").value =
                                settings.mockScenario;
                            currentScenario = settings.mockScenario;
                        }

                        // Restore current timestamp
                        if (settings.currentTimestamp) {
                            currentTimestamp = settings.currentTimestamp;
                            updateTimestampDisplay();
                        }

                        console.log("Restored settings:", settings);
                    } catch (e) {
                        console.warn("Failed to parse saved settings:", e);
                    }
                }
            }

            // Reset all settings and localStorage
            function resetSettings() {
                if (confirm("This will reset all settings, clear API cache, and reload the page. Continue?")) {
                    localStorage.removeItem(SETTINGS_KEY);
                    console.log("All settings cleared from localStorage");

                    // Clear API cache
                    fetch('/api/clear-cache')
                        .then(response => response.json())
                        .then(data => {
                            console.log("API cache cleared:", data);
                            location.reload();
                        })
                        .catch(error => {
                            console.error("Error clearing API cache:", error);
                            location.reload(); // Reload anyway
                        });
                }
            }

            // Initialize settings on page load
            document.addEventListener("DOMContentLoaded", function () {
                loadSettings();
                switchDisplay(); // Apply display type
                toggleScale(); // Apply scale setting
                toggleAutoUpdate(); // Apply auto-update setting
            });

            // Auto-refresh the display on page load
            window.addEventListener("load", function () {
                updateDisplay();
            });

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                saveSettings(); // Save settings on manual update
                updateDisplay();
            });

            function loadScenario(scenario) {
                const scenarios = {
                    extreme_cold: {
                        temp_c: -25,
                        humidity: 20,
                        csv_scenario: "trending_down",
                        status_scenario: "normal",
                    },
                    extreme_hot: {
                        temp_c: 45,
                        humidity: 15,
                        csv_scenario: "trending_up",
                        status_scenario: "long_running",
                    },
                    high_humidity: {
                        temp_c: 28,
                        humidity: 85,
                        csv_scenario: "volatile",
                        status_scenario: "normal",
                    },
                    low_humidity: {
                        temp_c: 22,
                        humidity: 10,
                        csv_scenario: "normal",
                        status_scenario: "normal",
                    },
                };

                if (scenarios[scenario]) {
                    const config = scenarios[scenario];
                    document.getElementById("temp_c").value = config.temp_c;
                    document.getElementById("humidity").value = config.humidity;
                    document.getElementById("csv_scenario").value =
                        config.csv_scenario;
                    document.getElementById("status_scenario").value =
                        config.status_scenario;
                    updateDisplay();
                }
            }

            function switchDisplay() {
                const displayType =
                    document.getElementById("display_type").value;
                saveSettings(); // Save settings when changed
                const img = document.getElementById("display-image");
                const specs = document.getElementById("display-specs");
                const scale2x = document.getElementById("scale2x");

                // Always use 400x300 display
                img.width = scale2x.checked ? 800 : 400;
                img.height = scale2x.checked ? 600 : 300;
                specs.innerHTML = `Display: 400×300 pixels | Tri-color E-ink | ${scale2x.checked ? "2×" : "1:1"} scale<br />Fonts: Vollkorn 20px (regular, bold, italic, bold-italic) + Atkinson Hyperlegible 15px (regular) and 20px (regular, bold) + Terminal 8px (matching hardware)`;

                updateDisplay();
            }

            function toggleScale() {
                saveSettings(); // Save settings when changed
                const img = document.getElementById("display-image");
                const specs = document.getElementById("display-specs");
                const scale2x = document.getElementById("scale2x");

                if (scale2x.checked) {
                    img.width = 800;
                    img.height = 600;
                    specs.innerHTML =
                        "Display: 400×300 pixels | Tri-color E-ink | 2× scale<br />Fonts: Vollkorn 20px (regular, bold, italic, bold-italic) + Atkinson Hyperlegible 15px (regular) and 20px (regular, bold) + Terminal 8px (matching hardware)";
                } else {
                    img.width = 400;
                    img.height = 300;
                    specs.innerHTML =
                        "Display: 400×300 pixels | Tri-color E-ink | 1:1 scale<br />Fonts: Vollkorn 20px (regular, bold, italic, bold-italic) + Atkinson Hyperlegible 15px (regular) and 20px (regular, bold) + Terminal 8px (matching hardware)";
                }
            }

            function updateDisplay() {
                const useMockWeather =
                    document.getElementById("use_mock_weather").checked;
                const displayType = document.getElementById("display_type").value;

                console.log("updateDisplay called - Mock:", useMockWeather, "Display:", displayType, "Scenario:", currentScenario, "Timestamp:", currentTimestamp);

                // Show loading state
                form.classList.add("loading");
                errorMessage.style.display = "none";

                // Collect form data
                const formData = new FormData(form);

                // Add mock weather data to form if enabled
                if (useMockWeather) {
                    formData.append("use_mock_weather", "on");
                    formData.append("mock_timestamp", currentTimestamp);
                    formData.append(
                        "mock_scenario",
                        document.getElementById("mock_scenario").value,
                    );
                    console.log("Added mock data to form:", document.getElementById("mock_scenario").value, currentTimestamp);
                }

                // Submit to server
                fetch("/preview", {
                    method: "POST",
                    body: new URLSearchParams(formData),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                          console.log(">>>>ZOMG data",data)
                            // Force image reload by adding timestamp
                            displayImage.src =
                                data.image_url + "?t=" + Date.now();

                            // Update status info based on display type
                            if (data.display_type === "400x300") {
                                statusContent.innerHTML = `
                            <strong>Display:</strong> 400×300 Text Renderer<br>
                            <strong>Text:</strong> <code>${data.text_content ? data.text_content.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "No text"}</code>
                        `;
                            } else if (data.sensor_data && data.system_status) {
                                statusContent.innerHTML = `
                            <strong>Sensor:</strong> ${data.sensor_data.temp_c.toFixed(1)}°C, ${data.sensor_data.humidity.toFixed(1)}%<br>
                            <strong>System:</strong> ${data.system_status.sd_available ? "SD OK" : "No SD"},
                            ${data.system_status.uptime} uptime, ${data.system_status.power_status}
                        `;
                            }
                        } else {
                            errorMessage.textContent = "Error: " + data.error;
                            errorMessage.style.display = "block";
                        }
                    })
                    .catch((error) => {
                        errorMessage.textContent =
                            "Network error: " + error.message;
                        errorMessage.style.display = "block";
                    })
                    .finally(() => {
                        form.classList.remove("loading");
                    });
            }

            // Auto-update timer (off by default)
            let autoUpdateTimer = null;
            let currentTimestamp = Math.floor(Date.now() / 1000);
            let currentScenario = "ny_2024";
            let seasons = ["winter", "spring", "summer", "fall"];
            let currentSeasonIndex = 0;
            let dataRanges = {};

            // Load data ranges on page load
            loadDataRanges();

            // Keyboard controls
            document.addEventListener("keydown", function (e) {
                if (!document.getElementById("use_mock_weather").checked)
                    return;
                if (document.getElementById("display_type").value !== "400x300")
                    return;

                console.log("Key pressed:", e.key, "Mock enabled:", document.getElementById("use_mock_weather").checked);

                switch (e.key) {
                    case "ArrowLeft":
                        e.preventDefault();
                        stepTime(-1);
                        break;
                    case "ArrowRight":
                        e.preventDefault();
                        stepTime(1);
                        break;
                    case "ArrowUp":
                        e.preventDefault();
                        stepSeason(-1);
                        break;
                    case "ArrowDown":
                        e.preventDefault();
                        stepSeason(1);
                        break;
                    case " ":
                        e.preventDefault();
                        regenerateScenario();
                        break;
                }
            });

            function stepTime(direction) {
                currentTimestamp += direction * 10800; // 3 hours
                console.log("Stepping time:", direction, "new timestamp:", currentTimestamp);
                updateTimestampDisplay();
                saveSettings(); // Save timestamp changes
                updateDisplay();
            }

            function stepSeason(direction) {
                // Check if using historical data
                if (currentScenario === "ny_2024" || currentScenario === "toronto_2025") {
                    // For historical data, up/down arrows step by one week (7 days = 604800 seconds)
                    currentTimestamp += direction * 604800;
                    console.log("Stepping week:", direction, "new timestamp:", currentTimestamp);
                    updateTimestampDisplay();
                    saveSettings(); // Save timestamp changes
                    updateDisplay();
                } else {
                    // For synthetic scenarios, cycle through seasons
                    currentSeasonIndex =
                        (currentSeasonIndex + direction + seasons.length) %
                        seasons.length;
                    const season = seasons[currentSeasonIndex];
                    const scenarios = {
                        winter: "winter_storm",
                        spring: "spring_rain",
                        summer: "summer_hot",
                        fall: "fall_rain",
                    };
                    currentScenario = scenarios[season];
                    document.getElementById("mock_scenario").value =
                        currentScenario;
                    updateDisplay();
                }
            }

            function regenerateScenario() {
                currentTimestamp += Math.floor(Math.random() * 7200) - 3600;
                updateTimestampDisplay();
                saveSettings(); // Save timestamp changes
                updateDisplay();
            }

            function toggleWeatherSource() {
                const useMock =
                    document.getElementById("use_mock_weather").checked;
                document.getElementById("mock_scenario").disabled = !useMock;
                currentScenario =
                    document.getElementById("mock_scenario").value;

                // Initialize timestamp appropriately when enabling mock weather
                if (useMock && (currentScenario === "ny_2024" || currentScenario === "toronto_2025")) {
                    initializeHistoricalTimestamp(currentScenario);
                }

                console.log("Weather source toggled:", useMock ? "mock" : "real");
                updateTimestampDisplay();
                saveSettings(); // Save weather source changes
                updateDisplay();
            }

            // Add event listener for scenario dropdown
            document.getElementById("mock_scenario").addEventListener("change", function() {
                currentScenario = this.value;
                console.log("Scenario changed to:", currentScenario);

                // Reset timestamp to appropriate range for historical data
                if (currentScenario === "ny_2024" || currentScenario === "toronto_2025") {
                    initializeHistoricalTimestamp(currentScenario);
                } else {
                    // Use current time for synthetic scenarios
                    currentTimestamp = Math.floor(Date.now() / 1000);
                }

                updateTimestampDisplay();
                saveSettings(); // Save scenario changes
                updateDisplay();
            });

            function toggleAutoUpdate() {
                saveSettings(); // Save settings when changed
                const checkbox = document.getElementById("auto-update");
                if (checkbox.checked) {
                    // Start auto-update
                    autoUpdateTimer = setInterval(updateDisplay, 5000);
                } else {
                    // Stop auto-update
                    if (autoUpdateTimer) {
                        clearInterval(autoUpdateTimer);
                        autoUpdateTimer = null;
                    }
                }
            }

            // Reset auto-update timer when user interacts (only if enabled)
            form.addEventListener("change", function () {
                const checkbox = document.getElementById("auto-update");
                if (checkbox.checked && autoUpdateTimer) {
                    clearInterval(autoUpdateTimer);
                    autoUpdateTimer = setInterval(updateDisplay, 5000);
                }
            });

            function loadDataRanges() {
                fetch('/api/data-ranges')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            dataRanges = data.ranges;
                            console.log("Loaded data ranges:", dataRanges);
                            updateTimestampDisplay();
                        } else {
                            console.error("Failed to load data ranges:", data.error);
                        }
                    })
                    .catch(error => {
                        console.error("Error loading data ranges:", error);
                    });
            }

            function initializeHistoricalTimestamp(scenario) {
                if (dataRanges[scenario]) {
                    currentTimestamp = dataRanges[scenario].start;
                    console.log(`Initialized timestamp for ${scenario}:`, currentTimestamp);
                } else {
                    // Fallback to hardcoded values if ranges not loaded yet
                    if (scenario === "ny_2024") {
                        currentTimestamp = 1704085200; // 2024-01-01 00:00:00 UTC
                    } else if (scenario === "toronto_2025") {
                        currentTimestamp = 1734480000; // 2024-12-18 00:00:00 UTC
                    }
                    console.log(`Fallback timestamp for ${scenario}:`, currentTimestamp);
                }
            }

            function updateTimestampDisplay() {
                const currentTimestampEl = document.getElementById("current-timestamp");
                const dataRangeEl = document.getElementById("data-range");
                const rangeWarningEl = document.getElementById("range-warning");

                // Format current timestamp
                const currentDate = new Date(currentTimestamp * 1000);
                currentTimestampEl.textContent = currentDate.toISOString().slice(0, 16).replace('T', ' ') + " UTC";

                // Show data range for historical scenarios
                if (currentScenario === "ny_2024" || currentScenario === "toronto_2025") {
                    const range = dataRanges[currentScenario];
                    if (range) {
                        const startDate = new Date(range.start * 1000);
                        const endDate = new Date(range.end * 1000);
                        dataRangeEl.textContent = `${startDate.toISOString().slice(0, 10)} to ${endDate.toISOString().slice(0, 10)}`;

                        // Check if current timestamp is within range
                        const isInRange = currentTimestamp >= range.start && currentTimestamp <= range.end;
                        rangeWarningEl.style.display = isInRange ? "none" : "block";
                    } else {
                        dataRangeEl.textContent = "Loading...";
                        rangeWarningEl.style.display = "none";
                    }
                } else {
                    dataRangeEl.textContent = "Synthetic data (all times valid)";
                    rangeWarningEl.style.display = "none";
                }

                // Show yesterday status for historical data
                updateYesterdayStatus();
            }

            function updateYesterdayStatus() {
                const yesterdayStatusEl = document.getElementById("yesterday-status");
                const yesterdayDataEl = document.getElementById("yesterday-data");

                if (currentScenario === "ny_2024" || currentScenario === "toronto_2025") {
                    // For historical data, show that yesterday data should be available
                    const yesterdayTimestamp = currentTimestamp - 86400;
                    const yesterdayDate = new Date(yesterdayTimestamp * 1000);
                    const range = dataRanges[currentScenario];

                    if (range && yesterdayTimestamp >= range.start && yesterdayTimestamp <= range.end) {
                        yesterdayDataEl.textContent = `${yesterdayDate.toISOString().slice(0, 10)} (available)`;
                        yesterdayDataEl.style.color = "#4CAF50"; // Green
                    } else {
                        yesterdayDataEl.textContent = `${yesterdayDate.toISOString().slice(0, 10)} (unavailable)`;
                        yesterdayDataEl.style.color = "#f44336"; // Red
                    }
                    yesterdayStatusEl.style.display = "block";
                } else {
                    yesterdayStatusEl.style.display = "none";
                }
            }
        </script>
    </body>
</html>
